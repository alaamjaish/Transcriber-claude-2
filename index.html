<!-- File: transcriber.html — Local (no server) voice + system audio transcription with Soniox + Diarization + OpenAI Summary per session
     Additions in this version:
       • Student Picker modal BEFORE recording (choose/create student)
       • Students panel (list + add student, open per-student page)
       • Sessions saved with studentId + shown in History
       • currentStudent pill showing who you’re recording for
       • Scroll lock fix: page doesn’t scroll while modal is open; lists in modal are scrollable
-->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Local Transcriber — Soniox (Mic + System/Tab Audio) + Diarization + OpenAI Summary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg: #0b0c10; --panel: #11141a; --muted: #667085; --text: #e6e6e6; --accent: #6ee7ff; --danger: #ff6b6b; --ok: #22c55e; --warn: #f59e0b;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
    .wrap{max-width:920px;margin:auto;padding:24px}
    .card{background:var(--panel);border:1px solid #1f2430;border-radius:16px;padding:20px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .grow{flex:1}
    label{font-size:14px;color:var(--muted);}
    input[type="text"], input[type="password"]{
      width:100%;padding:12px 14px;border-radius:12px;border:1px solid #262b36;background:#0d0f14;color:#e6e6e6;
    }
    button{
      border:0;border-radius:14px;padding:14px 18px;font-weight:700;cursor:pointer;
      background:#1a90ff;color:#fff;transition:transform .02s ease;
    }
    button:active{transform:translateY(1px)}
    button.secondary{background:#2b323f}
    button.danger{background:var(--danger)}
    button.ok{background:var(--ok);color:#0a0a0a}
    .big{font-size:18px;padding:18px 22px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#1a2130;color:#cbd5e1;font-size:12px}
    .statusdot{width:10px;height:10px;border-radius:50%;background:#475569;display:inline-block}
    .statusdot.live{background:#22c55e;box-shadow:0 0 0 0 rgba(34,197,94,.8);animation:pulse 1.4s infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(34,197,94,.6)}70%{box-shadow:0 0 0 10px rgba(34,197,94,0)}100%{box-shadow:0 0 0 0 rgba(34,197,94,0)}}
    .transcript{min-height:160px;white-space:pre-wrap;background:#0d0f14;border:1px solid #1f2430;border-radius:14px;padding:16px}
    .sub{color:#94a3b8;font-size:13px}
    .note{background:#0e121a;border:1px dashed #223049;border-radius:12px;padding:12px;font-size:13px;color:#b8c3cf}
    .warn{color:var(--warn)}
    .history{display:grid;gap:10px}
    .hist-item{background:#0d1017;border:1px solid #1f2430;border-radius:12px;padding:12px}
    .small{font-size:12px}
    .sliders{display:flex;gap:16px;align-items:center}
    input[type="range"]{width:180px}

    /* ===== simple modal (shared) ===== */
    .modal-back{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999;overflow:auto}
    .modal{max-width:640px;width:100%;background:var(--panel);border:1px solid #1f2430;border-radius:16px;padding:18px;max-height:90vh;display:flex;flex-direction:column}
    .list{display:grid;gap:8px;margin:10px 0}
    .list-item{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid #1f2430;border-radius:10px;background:#0d0f14}
    .muted{color:#94a3b8}
    .hr{height:1px;background:#1f2430;margin:10px 0}

    /* Scroll only modal, not page */
    body.modal-open{overflow:hidden}
    #spList, #stList{flex:1;min-height:0;max-height:60vh;overflow-y:auto;overscroll-behavior:contain;padding-right:6px}

    /* ===== AUTH UI ENHANCEMENTS ===== */
    /* Input focus states */
    #authSection input:focus {
      outline: none !important;
      border-color: var(--accent) !important;
      box-shadow: 0 0 0 3px rgba(110, 231, 255, 0.1) !important;
    }

    /* Button hover effects */
    #authSection button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }

    #authSection button:active {
      transform: translateY(0px);
    }

    /* Tab hover effects */
    .auth-tab:hover {
      background: rgba(110, 231, 255, 0.1) !important;
    }

    /* Auth section - positioning handled inline */

    /* Subtle animations */
    #authSection * {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Generating status animation */
    .generating-pill {
      background: #1e40af !important;
      color: #ffffff !important;
      animation: pulse-generating 2s infinite;
    }

    @keyframes pulse-generating {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }

    .generating-dots::after {
      content: '';
      animation: dots 1.5s infinite;
    }

    @keyframes dots {
      0%, 20% { content: ''; }
      40% { content: '.'; }
      60% { content: '..'; }
      80%, 100% { content: '...'; }
    }

    /* Green regenerate buttons */
    .regenerate-btn {
      background: #22c55e !important;
      color: #ffffff !important;
    }

    .regenerate-btn:hover {
      background: #16a34a !important;
    }
  </style>
</head>
<body>
<!-- AUTH SECTION -->
<div id="authSection" style="display:none; position:fixed; top:0; left:0; width:100%; height:100vh; background:linear-gradient(135deg, #0b0c10 0%, #1a1d29 100%); z-index:10000">
  <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:100%; max-width:480px; padding:20px; box-sizing:border-box">
  <div style="background:var(--panel); border:1px solid #2a2f3a; border-radius:24px; padding:40px; max-width:440px; width:100%; box-shadow:0 20px 60px rgba(0,0,0,0.4); backdrop-filter:blur(10px)">

    <!-- Logo/Brand Area -->
    <div style="text-align:center; margin-bottom:32px">
      <div style="width:64px; height:64px; background:linear-gradient(135deg, var(--accent) 0%, #4f9cf9 100%); border-radius:16px; margin:0 auto 16px; display:flex; align-items:center; justify-content:center; font-size:24px; font-weight:bold; color:white">T</div>
      <h1 style="margin:0 0 8px 0; font-size:28px; font-weight:700; background:linear-gradient(135deg, #ffffff 0%, #94a3b8 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text">Transcriber</h1>
      <p style="margin:0; color:var(--muted); font-size:16px">Real-time Arabic transcription & AI summaries</p>
    </div>

    <!-- Tab Navigation -->
    <div style="display:flex; background:#0d1017; border-radius:16px; padding:4px; margin-bottom:32px; border:1px solid #1f2430">
      <button id="signInTab" class="auth-tab active" style="flex:1; padding:12px 24px; border:none; border-radius:12px; background:var(--accent); color:#0a0a0a; font-weight:600; cursor:pointer; transition:all 0.3s ease">Sign In</button>
      <button id="signUpTab" class="auth-tab" style="flex:1; padding:12px 24px; border:none; border-radius:12px; background:transparent; color:var(--muted); font-weight:600; cursor:pointer; transition:all 0.3s ease">Sign Up</button>
    </div>

    <!-- Sign In Form -->
    <div id="signInForm" class="auth-form">
      <div style="margin-bottom:24px">
        <label style="display:block; margin-bottom:8px; font-weight:500; color:#e2e8f0">Email Address</label>
        <input id="signInEmail" type="email" placeholder="Enter your email" style="width:100%; padding:16px 20px; border-radius:12px; border:1px solid #2a2f3a; background:#0d1017; color:#ffffff; font-size:16px; transition:all 0.3s ease; box-sizing:border-box" />
      </div>

      <div style="margin-bottom:32px">
        <label style="display:block; margin-bottom:8px; font-weight:500; color:#e2e8f0">Password</label>
        <input id="signInPassword" type="password" placeholder="Enter your password" style="width:100%; padding:16px 20px; border-radius:12px; border:1px solid #2a2f3a; background:#0d1017; color:#ffffff; font-size:16px; transition:all 0.3s ease; box-sizing:border-box" />
      </div>

      <button id="signInBtn" style="width:100%; padding:16px; border:none; border-radius:12px; background:linear-gradient(135deg, var(--accent) 0%, #4f9cf9 100%); color:#0a0a0a; font-weight:600; font-size:16px; cursor:pointer; transition:all 0.3s ease; margin-bottom:16px">Sign In</button>
    </div>

    <!-- Sign Up Form -->
    <div id="signUpForm" class="auth-form" style="display:none">
      <div style="margin-bottom:24px">
        <label style="display:block; margin-bottom:8px; font-weight:500; color:#e2e8f0">Email Address</label>
        <input id="signUpEmail" type="email" placeholder="Enter your email" style="width:100%; padding:16px 20px; border-radius:12px; border:1px solid #2a2f3a; background:#0d1017; color:#ffffff; font-size:16px; transition:all 0.3s ease; box-sizing:border-box" />
      </div>

      <div style="margin-bottom:32px">
        <label style="display:block; margin-bottom:8px; font-weight:500; color:#e2e8f0">Password</label>
        <input id="signUpPassword" type="password" placeholder="Create a password (6+ characters)" style="width:100%; padding:16px 20px; border-radius:12px; border:1px solid #2a2f3a; background:#0d1017; color:#ffffff; font-size:16px; transition:all 0.3s ease; box-sizing:border-box" />
      </div>

      <button id="signUpBtn" style="width:100%; padding:16px; border:none; border-radius:12px; background:linear-gradient(135deg, var(--ok) 0%, #15803d 100%); color:#ffffff; font-weight:600; font-size:16px; cursor:pointer; transition:all 0.3s ease; margin-bottom:16px">Create Account</button>
    </div>

    <!-- Messages -->
    <div id="authMessage" style="text-align:center; padding:12px; border-radius:8px; margin-top:16px; display:none; font-weight:500"></div>
    </div>
  </div>
</div>

<!-- MAIN APP (hidden until authenticated) -->
<div id="appSection" class="wrap" style="display:none">
  <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:18px">
    <div>
      <h2 style="margin:0">Local Transcriber</h2>
      <div class="sub">Mic + (optional) system/tab audio → real-time Soniox transcription with speaker diarization.</div>
    </div>
    <div class="row">
      <span id="userEmail" class="pill"></span>
      <button id="logoutBtn" class="secondary">Logout</button>
    </div>
  </div>


  <!-- CONTROLS -->
  <div class="card" style="margin-bottom:16px">
    <div class="row" style="justify-content:space-between;margin-bottom:10px">
      <div class="row">
        <span class="pill"><span id="statusDot" class="statusdot"></span><span id="statusText">idle</span></span>
      </div>
      <div class="row small">
        <span id="currentModel" class="pill">model: stt-rt-preview</span>
        <span id="langId" class="pill">multilingual: on</span>
        <span class="pill"><span>speakers:</span><span id="speakersCount">0</span></span>
        <span class="pill"><span>sessions:</span><span id="sessionCount">0</span></span>
        <span id="currentStudentPill" class="pill">student: —</span>
      </div>
    </div>

    <div class="row" style="margin-bottom:10px">
      <div class="row">
        <input id="captureSystem" type="checkbox" />
        <label for="captureSystem" style="margin-left:6px">Capture browser/system audio (tab/system sound)</label>
      </div>
      <div class="row sliders">
        <label>Mic gain</label><input id="micGain" type="range" min="0" max="200" value="100">
        <label>System gain</label><input id="sysGain" type="range" min="0" max="200" value="100">
      </div>
      <div class="grow"></div>
      <div class="row">
        <button id="startBtn" class="big">Start Transcribing</button>
        <button id="stopBtn" class="big danger" disabled>Stop</button>
        <button id="cancelBtn" class="big secondary" disabled>Cancel</button>
      </div>
    </div>

    <div class="note" id="sysNote" style="display:none;margin-top:8px">
      Pick <b>This Tab</b> + enable <b>Share tab audio</b>, or pick <b>Entire screen</b> + enable <b>Share system audio</b> (Windows/ChromeOS).
      macOS typically allows <i>tab audio</i> only. If no system audio track is detected, you'll see a warning.
    </div>

    <div id="systemWarn" class="sub warn" style="display:none;margin-top:8px"></div>

    <div class="row" style="margin-top:12px">
      <button id="settingsBtn" class="secondary">Settings</button>
      <button id="studentsBtn" class="secondary">Students</button>
    </div>
  </div>

  <!-- LIVE + FINAL -->
  <div class="card" style="margin-bottom:16px">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:10px">
      <div class="row"><strong>Live Transcript</strong></div>
      <div class="small sub" id="timer">00:00</div>
    </div>
    <div id="live" class="transcript" aria-live="polite"></div>
    <div class="sub" style="margin-top:10px">Final (words locked):</div>
    <div id="final" class="transcript"></div>
  </div>

  <!-- HISTORY -->
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:10px">
      <strong>Session History</strong>
      <span class="small sub">Saved locally</span>
    </div>
    <div id="history" class="history"></div>
  </div>

  <p class="sub" style="margin-top:18px">
    Tips: Chrome/Edge give best system-audio capture. Soniox auto-detects languages (English + Arabic). "Summary" uses OpenAI to generate a lesson-note Markdown.
  </p>
</div>

<!-- ===== Student Picker Modal (before recording) ===== -->
<div id="studentPickerBack" class="modal-back" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">Choose Student</h3>
      <button id="spClose" class="secondary">Close</button>
    </div>
    <div class="sub">Pick who this recording belongs to. You can add a new student below.</div>

    <div id="spList" class="list" style="margin-top:10px"></div>

    <div class="hr"></div>
    <label for="spNewName">+ New student</label>
    <div class="row">
      <input id="spNewName" type="text" placeholder="Type a name, e.g., Ali" />
      <button id="spAdd" class="ok">Add</button>
    </div>

    <div class="row" style="justify-content:flex-end;margin-top:12px">
      <button id="spCancel" class="secondary">Cancel</button>
      <button id="spConfirm" class="big">Continue & Start</button>
    </div>
  </div>
</div>

<!-- ===== Students Panel (list + add) ===== -->
<div id="studentsBack" class="modal-back" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">Students</h3>
      <button id="stClose" class="secondary">Close</button>
    </div>
    <div id="stList" class="list" style="margin-top:10px"></div>
    <div class="hr"></div>
    <label for="stNewName">+ New student</label>
    <div class="row">
      <input id="stNewName" type="text" placeholder="Type a name, e.g., Samir" />
      <button id="stAdd" class="ok">Add</button>
    </div>
  </div>
</div>

<!-- BYOK Modal -->
<div id="byokBack" class="modal-back" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">API Keys Setup</h3>
      <button id="byokClose" class="secondary" style="display:none">Close</button>
    </div>
    <div class="sub">Please provide your API keys to use the transcription and summary features. Keys are stored securely in your browser.</div>

    <div style="margin-top:16px">
      <label for="byokSoniox">Soniox API Key</label>
      <input id="byokSoniox" type="password" placeholder="soniox_************************" autocomplete="off" />
      <div class="sub">Used for speech-to-text transcription. Get yours from <a href="https://soniox.com" target="_blank">soniox.com</a></div>
    </div>

    <div style="margin-top:16px">
      <label for="byokOpenAI">OpenAI API Key</label>
      <input id="byokOpenAI" type="password" placeholder="sk-************************" autocomplete="off" />
      <div class="sub">Used for lesson summaries and homework generation. Get yours from <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a></div>
    </div>

    <div id="byokMessage" class="sub" style="margin-top:12px; color: var(--warn); display:none"></div>

    <div class="row" style="justify-content:flex-end;margin-top:16px">
      <button id="byokSave" class="big ok">Save Keys & Continue</button>
    </div>
  </div>
</div>

<script type="module">
  import { SonioxClient } from 'https://unpkg.com/@soniox/speech-to-text-web?module';
  import { getOpenAIKey, generateSummary, generateHomework, autoGenerateContent, isGenerating, setGeneratingStatus, isEmpty, setEmptyStatus } from './ai-features/summarizer.js';

  // ===== SUPABASE CONFIG =====
  const SUPABASE_URL = 'https://fuzhshhbmqmkqjdakalg.supabase.co'
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1emhzaGhibXFta3FqZGFrYWxnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3MDY1NzUsImV4cCI6MjA3NDI4MjU3NX0.43jA6eCWf8QL69FYPDt82y3RLaAcnhiIFFNwPCxjgBM'
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

  // ===== AUTH DOM =====
  // ===== AUTH DOM =====
  const authSection = document.getElementById('authSection')
  const appSection = document.getElementById('appSection')

  // Tab elements
  const signInTab = document.getElementById('signInTab')
  const signUpTab = document.getElementById('signUpTab')

  // Form elements
  const signInForm = document.getElementById('signInForm')
  const signUpForm = document.getElementById('signUpForm')

  // Sign In form
  const signInEmail = document.getElementById('signInEmail')
  const signInPassword = document.getElementById('signInPassword')
  const signInBtn = document.getElementById('signInBtn')

  // Sign Up form
  const signUpEmail = document.getElementById('signUpEmail')
  const signUpPassword = document.getElementById('signUpPassword')
  const signUpBtn = document.getElementById('signUpBtn')

  // Shared elements
  const authMessage = document.getElementById('authMessage')
  const userEmail = document.getElementById('userEmail')
  const logoutBtn = document.getElementById('logoutBtn')

  // Auth state
  let currentAuthMode = 'signin' // 'signin' or 'signup'

  // ===== BYOK DOM =====
  const byokBack = document.getElementById('byokBack')
  const byokClose = document.getElementById('byokClose')
  const byokSoniox = document.getElementById('byokSoniox')
  const byokOpenAI = document.getElementById('byokOpenAI')
  const byokMessage = document.getElementById('byokMessage')
  const byokSave = document.getElementById('byokSave')
  const settingsBtn = document.getElementById('settingsBtn')

  // ===== DOM =====
  const captureSystem = document.getElementById('captureSystem');
  const sysNote = document.getElementById('sysNote');
  const sysWarn = document.getElementById('systemWarn');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const statusDot = document.getElementById('statusDot');
  const statusText = document.getElementById('statusText');
  const liveEl = document.getElementById('live');
  const finalEl = document.getElementById('final');
  const timerEl = document.getElementById('timer');
  const historyEl = document.getElementById('history');
  const sessionCountEl = document.getElementById('sessionCount');
  const speakersCountEl = document.getElementById('speakersCount');
  const micGainEl = document.getElementById('micGain');
  const sysGainEl = document.getElementById('sysGain');
  const currentStudentPill = document.getElementById('currentStudentPill');
  const studentsBtn = document.getElementById('studentsBtn');

  // Student Picker modal
  const spBack = document.getElementById('studentPickerBack');
  const spList = document.getElementById('spList');
  const spNewName = document.getElementById('spNewName');
  const spAdd = document.getElementById('spAdd');
  const spConfirm = document.getElementById('spConfirm');
  const spCancel = document.getElementById('spCancel');
  const spClose = document.getElementById('spClose');

  // Students panel modal
  const stBack = document.getElementById('studentsBack');
  const stList = document.getElementById('stList');
  const stNewName = document.getElementById('stNewName');
  const stAdd = document.getElementById('stAdd');
  const stClose = document.getElementById('stClose');

  // ===== Scroll lock helpers =====
  function lockBodyScroll(){ document.body.classList.add('modal-open'); }
  function unlockBodyScroll(){ document.body.classList.remove('modal-open'); }
  function anyModalOpen(){ return (spBack.style.display==='flex') || (stBack.style.display==='flex'); }

  // extra guard to stop scroll on backdrop (allow inner list to scroll)
  ['wheel','touchmove'].forEach(evt => {
    [spBack, stBack].forEach(el => {
      el.addEventListener(evt, (e) => {
        if (e.target === el) e.preventDefault();
      }, { passive:false });
    });
  });

  // ===== STATE =====
  let soniox = null;
  let audioCtx = null;
  let micStream = null;
  let displayStream = null;
  let mixedStream = null;
  let micGainNode = null;
  let sysGainNode = null;
  let destNode = null;
  let running = false;
  let startedAt = 0;
  let timerInt = null;

  // Students
  let currentStudentId = localStorage.getItem('currentStudentId') || '';
  function uid(){ return Math.random().toString(36).slice(2,8) + '-' + Date.now().toString(36); }
  function cleanName(n){ return (n||'').trim().replace(/\s+/g,' ').slice(0,64); }

  async function getStudents(){
    try {
      const { data, error } = await supabase
        .from('students')
        .select('*')
        .order('created_at', { ascending: false })
      if (error) throw error
      return data || []
    } catch (e) {
      console.error('Error getting students:', e)
      return []
    }
  }

  async function addStudent(name){
    const nm = cleanName(name);
    if (!nm) return null;

    // Check if student already exists for this user
    const { data: existing } = await supabase
      .from('students')
      .select('*')
      .eq('name', nm)
      .maybeSingle()

    if (existing) return existing; // reuse

    // Create new student with owner_user_id
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) throw new Error('Not authenticated')

    const { data, error } = await supabase
      .from('students')
      .insert([{
        name: nm,
        owner_user_id: user.id
      }])
      .select()
      .single()

    if (error) throw error
    return data;
  }

  async function getStudentById(id){
    try {
      const { data, error } = await supabase
        .from('students')
        .select('*')
        .eq('id', id)
        .single()
      if (error) throw error
      return data
    } catch (e) {
      console.error('Error getting student:', e)
      return null
    }
  }

  async function setCurrentStudent(id){
    currentStudentId = id || '';
    localStorage.setItem('currentStudentId', currentStudentId);
    if (id) {
      const s = await getStudentById(id);
      currentStudentPill.textContent = 'student: ' + (s ? s.name : '—');
    } else {
      currentStudentPill.textContent = 'student: —';
    }
  }
  // initialize pill (will be called in showApp)

  // text assembly with diarization
  let finalSegments = [];  // [{label: 'Speaker 1', text: '...'}]
  let lastRenderedLive = '';
  const speakerMap = new Map(); // numericSpeakerId -> 'Speaker N'
  function resetSpeakersUI(){ speakersCountEl.textContent = '0'; }
  function getSpeakerId(tok){
    return tok?.speaker ?? tok?.speaker_id ?? tok?.spk ?? tok?.spk_id ?? tok?.channel ?? 0;
  }
  function labelForSpeaker(id){
    const key = String(id);
    if (!speakerMap.has(key)){
      const nextNum = speakerMap.size + 1;
      speakerMap.set(key, `Speaker ${nextNum}`);
      speakersCountEl.textContent = String(speakerMap.size);
    }
    return speakerMap.get(key);
  }
  function renderSegments(segments){
    return segments.map(s => `${s.label}: ${s.text}`).join('\n');
  }
  function cloneSegments(){ return finalSegments.map(s => ({label:s.label, text:s.text})); }

  // ===== HELPER FUNCTIONS =====

  // ===== BYOK MODAL FUNCTIONS =====
  function showBYOKModal(blocking = false) {
    // Load existing keys
    byokSoniox.value = localStorage.getItem('soniox_api_key') || ''
    byokOpenAI.value = localStorage.getItem('openai_api_key') || ''

    // Show/hide close button based on blocking mode
    byokClose.style.display = blocking ? 'none' : 'inline-block'

    // Clear any previous messages
    byokMessage.style.display = 'none'
    byokMessage.textContent = ''

    // Show modal
    byokBack.style.display = 'flex'
    byokSoniox.focus()

    // Lock body scroll if blocking
    if (blocking) {
      document.body.classList.add('modal-open')
    }
  }

  function closeBYOKModal() {
    byokBack.style.display = 'none'
    document.body.classList.remove('modal-open')
  }

  function validateBYOKKeys(sonioxKey, openaiKey) {
    const errors = []

    if (!sonioxKey || !sonioxKey.trim()) {
      errors.push('Soniox API key is required')
    }

    if (!openaiKey || !openaiKey.trim()) {
      errors.push('OpenAI API key is required')
    } else if (!openaiKey.startsWith('sk-')) {
      errors.push('OpenAI API key should start with "sk-"')
    }

    return errors
  }

  function areBYOKKeysSet() {
    const soniox = localStorage.getItem('soniox_api_key')
    const openai = localStorage.getItem('openai_api_key')
    return !!(soniox && openai)
  }

  // BYOK Modal Event Handlers
  byokSave.onclick = async () => {
    const sonioxKey = byokSoniox.value.trim()
    const openaiKey = byokOpenAI.value.trim()

    const errors = validateBYOKKeys(sonioxKey, openaiKey)

    if (errors.length > 0) {
      byokMessage.textContent = errors.join('. ')
      byokMessage.style.display = 'block'
      return
    }

    // Save keys to localStorage
    localStorage.setItem('soniox_api_key', sonioxKey)
    localStorage.setItem('openai_api_key', openaiKey)

    // Hide modal
    closeBYOKModal()

    // If this was blocking mode (first-time setup), continue app initialization
    const wasBlocking = byokClose.style.display === 'none'
    if (wasBlocking) {
      await setCurrentStudent(currentStudentId) // Initialize the current student pill
      await renderHistory()
    }

    // Success message
    alert('API keys saved successfully!')
  }

  byokClose.onclick = closeBYOKModal

  settingsBtn.onclick = () => showBYOKModal(false)

  captureSystem.addEventListener('change', () => {
    sysNote.style.display = captureSystem.checked ? 'block' : 'none';
  });

  micGainEl.addEventListener('input', () => { if (micGainNode) micGainNode.gain.value = Number(micGainEl.value)/100; });
  sysGainEl.addEventListener('input', () => { if (sysGainNode) sysGainNode.gain.value = Number(sysGainEl.value)/100; });

  // ===== STATUS =====
  function setStatus(text, mode='idle'){
    statusText.textContent = text;
    statusDot.className = 'statusdot' + (mode==='live' ? ' live' : mode==='busy' ? ' busy' : mode==='err' ? ' err' : '');
  }
  function setButtonsRecordingState(isRecording){
    if (isRecording){
      startBtn.textContent = 'Recording…';
      startBtn.disabled = true;
      stopBtn.disabled = false;
      cancelBtn.disabled = false;
    } else {
      startBtn.textContent = 'Start Transcribing';
      startBtn.disabled = false;
      stopBtn.disabled = true;
      cancelBtn.disabled = true;
    }
  }
  function fmtTime(ms){
    const s = Math.floor(ms/1000);
    const mm = String(Math.floor(s/60)).padStart(2,'0');
    const ss = String(s%60).padStart(2,'0');
    return `${mm}:${ss}`;
  }
  function startTimer(){
    startedAt = Date.now();
    timerInt = setInterval(()=>{ timerEl.textContent = fmtTime(Date.now()-startedAt); }, 200);
  }
  function stopTimer(){
    clearInterval(timerInt);
    timerEl.textContent = '00:00';
  }

  // ===== AUDIO (mix mic + system/tab) =====
  async function buildMixedStream(wantSystemAudio){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 48000 });
    destNode = audioCtx.createMediaStreamDestination();

    // mic — disable echoCancellation to avoid AEC killing system audio when mixing
    micStream = await navigator.mediaDevices.getUserMedia({
      audio: { echoCancellation:false, noiseSuppression:true, autoGainControl:true },
      video:false
    });
    const micSrc = audioCtx.createMediaStreamSource(micStream);
    micGainNode = audioCtx.createGain(); micGainNode.gain.value = Number(micGainEl.value)/100;
    micSrc.connect(micGainNode).connect(destNode);

    // optional system/tab
    sysWarn.style.display = 'none';
    if (wantSystemAudio) {
      try {
        displayStream = await navigator.mediaDevices.getDisplayMedia({
          video:true,
          audio: { systemAudio: 'include' } // some browsers ignore; harmless
        });
        const hasAudio = displayStream.getAudioTracks().length > 0;
        if (!hasAudio) {
          sysWarn.textContent = 'No system/tab audio track detected. Enable "Share tab audio" (or "Share system audio" on Windows).';
          sysWarn.style.display = 'block';
        } else {
          const sysSrc = audioCtx.createMediaStreamSource(displayStream);
          sysGainNode = audioCtx.createGain(); sysGainNode.gain.value = Number(sysGainEl.value)/100;
          sysSrc.connect(sysGainNode).connect(destNode);
        }

        // if user stops screen-share from Chrome UI
        const vTracks = displayStream.getVideoTracks();
        if (vTracks[0]) vTracks[0].addEventListener('ended', () => {
          console.warn('Screen share ended by user.');
          if (running) stopTranscription();
        });
      } catch(e){
        console.warn('Display media not granted, continuing mic-only.', e);
        sysWarn.textContent = 'Screen share permission denied. Transcribing microphone only.';
        sysWarn.style.display = 'block';
      }
    }

    mixedStream = destNode.stream;
    return mixedStream;
  }
  function stopAllTracks(){
    [micStream, displayStream].forEach(s => {
      if (!s) return;
      s.getTracks().forEach(t => t.stop());
    });
    micStream = displayStream = null;
    mixedStream = null;
    if (audioCtx) { audioCtx.close().catch(()=>{}); audioCtx = null; }
  }

  // ===== SESSIONS (Supabase) =====
  async function saveSession(text, durMs){
    try {
      const { data: { user } } = await supabase.auth.getUser()
      if (!user) throw new Error('Not authenticated')

      const { data, error } = await supabase
        .from('sessions')
        .insert([{
          timestamp: new Date().toISOString(),
          duration_ms: durMs,
          transcript: text,
          student_id: currentStudentId || null,
          owner_user_id: user.id
        }])
        .select()
        .single()

      if (error) throw error
      await renderHistory();
      return data;
    } catch (e) {
      console.error('Error saving session:', e)
      alert('Failed to save session: ' + e.message)
    }
  }
  async function loadSessions(){
    try {
      const { data, error } = await supabase
        .from('sessions')
        .select(`
          *,
          student:students(name)
        `)
        .order('created_at', { ascending: false })
        .limit(5)

      if (error) throw error
      return data || []
    } catch (e) {
      console.error('Error loading sessions:', e)
      return []
    }
  }

  // ===== TOKEN FILTERS =====
  function isDisplayableTokenText(txt){
    if (!txt) return false;
    const t = String(txt);
    if (!t.trim()) return false;
    const low = t.trim().toLowerCase();
    if (low === 'end' || low === 'endpoint') return false;
    if (/^<[^>]+>$/.test(t)) return false;
    return true;
  }

  // ===== TRANSCRIPTION (with diarization grouping) =====
  function resetText(){
    finalSegments = [];
    lastRenderedLive = '';
    speakerMap.clear(); resetSpeakersUI();
    liveEl.textContent = '';
    finalEl.textContent = '';
  }

  function appendFinalToken(tok){
    const txt = String(tok.text || '');
    if (!isDisplayableTokenText(txt)) return;
    const label = labelForSpeaker(getSpeakerId(tok));
    if (finalSegments.length === 0 || finalSegments[finalSegments.length - 1].label !== label){
      finalSegments.push({ label, text: txt });
    } else {
      finalSegments[finalSegments.length - 1].text += txt;
    }
  }

  function buildLiveFromNonfinal(tokens){
    const copy = cloneSegments();
    tokens.forEach(tok => {
      const txt = String(tok.text || '');
      if (!isDisplayableTokenText(txt)) return;
      const label = labelForSpeaker(getSpeakerId(tok));
      if (copy.length === 0 || copy[copy.length - 1].label !== label){
        copy.push({ label, text: txt });
      } else {
        copy[copy.length - 1].text += txt;
      }
    });
    return renderSegments(copy);
  }

  // ======= Student Picker flow =======
  async function openStudentPicker(){
    // build list
    spList.innerHTML = '';
    const students = await getStudents();
    if (students.length === 0){
      const p = document.createElement('div');
      p.className = 'muted';
      p.textContent = 'No students yet. Add one below.';
      spList.appendChild(p);
    } else {
      students.forEach(s => {
        const id = 'sp-' + s.id;
        const div = document.createElement('label');
        div.className = 'list-item';
        div.innerHTML = `
          <input type="radio" name="spick" value="${s.id}" id="${id}">
          <div class="grow">
            <div><strong>${s.name}</strong></div>
            <div class="small muted">${s.id}</div>
          </div>
        `;
        spList.appendChild(div);
      });
      // preselect last used
      const pre = currentStudentId && document.querySelector(`input[name="spick"][value="${currentStudentId}"]`);
      (pre || document.querySelector('input[name="spick"]'))?.setAttribute('checked','checked');
    }
    spNewName.value = '';
    spBack.style.display = 'flex';
    spNewName.placeholder = 'Type a name, e.g., Ali';
    lockBodyScroll(); // prevent page scroll while modal open
  }
  function closeStudentPicker(){
    spBack.style.display = 'none';
    if (!anyModalOpen()) unlockBodyScroll();
  }

  spAdd.onclick = async () => {
    const nm = cleanName(spNewName.value);
    if (!nm) { alert('Type a student name.'); return; }
    const s = await addStudent(nm);
    if (!s) return;
    // rebuild list & preselect new
    await openStudentPicker();
    const pre = document.querySelector(`input[name="spick"][value="${s.id}"]`);
    pre?.setAttribute('checked','checked');
  };
  spConfirm.onclick = async () => {
    const sel = document.querySelector('input[name="spick"]:checked');
    if (sel) {
      await setCurrentStudent(sel.value);
      closeStudentPicker();
      await startTranscription(); // proceed
      return;
    }
    const nm = cleanName(spNewName.value);
    if (nm){
      const s = await addStudent(nm);
      if (s){ await setCurrentStudent(s.id); closeStudentPicker(); await startTranscription(); }
    } else {
      alert('Choose or add a student first.');
    }
  };
  spCancel.onclick = closeStudentPicker;
  spClose.onclick = closeStudentPicker;

  // ===== Students panel (list + add) =====
  async function openStudentsPanel(){
    stList.innerHTML = '';
    const arr = await getStudents();
    if (arr.length === 0){
      const p = document.createElement('div');
      p.className = 'muted';
      p.textContent = 'No students yet.';
      stList.appendChild(p);
    } else {
      arr.forEach(s => {
        // count sessions (fast path if indexed)
        const key = `studentSessions-${s.id}`;
        let cnt = 0;
        try { cnt = (JSON.parse(localStorage.getItem(key)||'[]')||[]).length; } catch {}
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `
          <div class="grow">
            <div><strong>${s.name}</strong></div>
            <div class="small muted">${cnt} session${cnt===1?'':'s'} • ${s.id}</div>
          </div>
          <button data-act="open" data-id="${s.id}" class="secondary">Open</button>
          <button data-act="set" data-id="${s.id}" class="secondary">Set as current</button>
        `;
        stList.appendChild(div);
      });
    }
    stNewName.value = '';
    stBack.style.display = 'flex';
    lockBodyScroll(); // prevent page scroll while modal open
  }
  function closeStudentsPanel(){
    stBack.style.display = 'none';
    if (!anyModalOpen()) unlockBodyScroll();
  }

  stAdd.onclick = async () => {
    const nm = cleanName(stNewName.value);
    if (!nm) { alert('Type a student name.'); return; }
    const s = await addStudent(nm);
    if (s){ await setCurrentStudent(s.id); await openStudentsPanel(); }
  };
  stClose.onclick = closeStudentsPanel;
  studentsBtn.onclick = () => openStudentsPanel();

  // Clicks in Students list
  stList.addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const id = btn.getAttribute('data-id');
    const act = btn.getAttribute('data-act');
    if (act === 'open') {
      location.href = 'student.html?id=' + encodeURIComponent(id);
      return;
    }
    if (act === 'set') {
      setCurrentStudent(id);
      alert('Current student set to: ' + (getStudentById(id)?.name || id));
      openStudentsPanel();
    }
  });

  // ===== TRANSCRIBE LIFECYCLE =====
  async function startTranscription(){
    // Check if both API keys are set
    if (!areBYOKKeysSet()) {
      return alert('API keys not configured. Please set your Soniox and OpenAI keys in Settings.');
    }

    const apiKey = localStorage.getItem('soniox_api_key');
    // Ensure a student is selected
    if (!currentStudentId){
      openStudentPicker();
      return;
    }

    setStatus('requesting permissions…', 'busy');
    resetText();
    setButtonsRecordingState(false); // during setup

    try {
      const stream = await buildMixedStream(captureSystem.checked);
      setStatus('connecting…', 'busy');

      soniox = new SonioxClient({
        apiKey: () => localStorage.getItem('soniox_api_key'),
        onStarted: () => {
          running = true;
          setStatus('LIVE', 'live');
          setButtonsRecordingState(true);
          startTimer();
        },
        onFinished: async () => {
          running = false;
          setStatus('finished');
          stopTimer();
          const sessionData = await saveSession((finalEl.textContent || '').trim(), Date.now() - startedAt);
          stopAllTracks();
          setButtonsRecordingState(false);

          // CHECK transcript FIRST, then set appropriate status
          if (sessionData && sessionData.id) {
            const transcript = (finalEl.textContent || '').trim();

            if (!transcript) {
              // Empty transcript - set empty status
              setEmptyStatus(sessionData.id);
              await renderHistory(); // Show empty notice
            } else {
              // Valid transcript - set generating status and start generation
              setGeneratingStatus(sessionData.id);
              await renderHistory(); // Show generating pills

              // THEN start auto-generation in background
              autoGenerateContent(sessionData.id, transcript, supabase);
            }
          }
        },
        onError: (status, message) => {
          console.error('Soniox error:', status, message);
          setStatus(message || status, 'err');
          running = false;
          stopTimer();
          stopAllTracks();
          setButtonsRecordingState(false);
          if (status === 'api_error' && /401|unauthorized/i.test(String(message))) {
            alert('Invalid Soniox API key. Please check your settings.');
          }
        }
      });

      await soniox.start({
        model: 'stt-rt-preview',
        stream,
        enableEndpointDetection: false,
        enableLanguageIdentification: true,
        languageHints: ['en','ar'],
        enableSpeakerDiarization: true,
        onPartialResult: (result) => {
          try {
            const tokens = Array.isArray(result?.tokens) ? result.tokens : [];
            for (const t of tokens) { if (t?.is_final) appendFinalToken(t); }
            finalEl.textContent = renderSegments(finalSegments);

            const nonfinal = tokens.filter(t => !t?.is_final);
            const liveNow = buildLiveFromNonfinal(nonfinal);
            if (liveNow !== lastRenderedLive){
              lastRenderedLive = liveNow;
              liveEl.textContent = liveNow;
            }
          } catch (e) {
            console.warn('onPartialResult parse issue:', e);
          }
        }
      });

    } catch (e) {
      console.error(e);
      if (String(e).includes('NotAllowedError')) {
        setStatus('mic/screen permission denied', 'err');
        alert('Permission denied. Enable microphone (and screen audio if selected).');
      } else if (String(e).includes('NotFoundError')) {
        setStatus('no audio device found', 'err');
        alert('No microphone found.');
      } else {
        setStatus('failed to start', 'err');
        alert('Failed to start. See console for details.');
      }
      stopAllTracks();
      setButtonsRecordingState(false);
    }
  }

  async function stopTranscription(){
    if (!running || !soniox) return;
    setStatus('stopping…', 'busy');
    stopBtn.disabled = true;
    try {
      await soniox.stop(); // waits for finalization
    } catch (e) {
      console.warn('stop error', e);
      stopTimer();
      await saveSession((finalEl.textContent || '').trim(), Date.now() - startedAt);
      stopAllTracks();
      setStatus('finished');
      setButtonsRecordingState(false);
    }
  }
  function cancelTranscription(){
    if (!running || !soniox) return;
    setStatus('cancelling…', 'busy');
    cancelBtn.disabled = true;
    try { soniox.cancel(); } catch {}
    running = false;
    stopTimer();
    stopAllTracks();
    setStatus('cancelled');
    setButtonsRecordingState(false);
  }

  // Start opens picker first
  startBtn.onclick = () => openStudentPicker();
  stopBtn.onclick = stopTranscription;
  cancelBtn.onclick = cancelTranscription;

  // Heads-up if the environment blocks mic from file://
  if (!('mediaDevices' in navigator)) {
    setStatus('your browser blocked mic (secure context required)', 'err');
  }

  // ====== OPENAI SUMMARY CONFIG ======
  // AI functions now imported from ./ai-features/summarizer.js

  async function summarizeSessionById(sessionId, btnElem) {
    // Get session from Supabase
    const { data: s, error } = await supabase
      .from('sessions')
      .select('*')
      .eq('id', sessionId)
      .single()

    if (error || !s) return alert('Session not found.');

    if (s.summary_md && !confirm('A summary already exists. Regenerate it?')) return;

    try {
      if (btnElem) { btnElem.disabled = true; btnElem.textContent = 'Summarizing…'; }
      const md = await generateSummary(s.transcript || '');

      // Update summary in Supabase
      await supabase
        .from('sessions')
        .update({ summary_md: md || '' })
        .eq('id', sessionId)

      await renderHistory();
      const pre = document.getElementById('s-' + sessionId);
      if (pre) { pre.textContent = md || ''; pre.style.display = 'block'; }
      alert('Summary ready.');
    } catch (e) {
      console.error(e);
      alert('Failed to summarize: ' + e.message);
    } finally {
      if (btnElem) { btnElem.disabled = false; btnElem.textContent = 'Regenerate'; }
    }
  }

  async function homeworkSessionById(sessionId, btnElem) {
    // Get session from Supabase
    const { data: s, error } = await supabase
      .from('sessions')
      .select('*')
      .eq('id', sessionId)
      .single()

    if (error || !s) return alert('Session not found.');

    if (s.homework_md && !confirm('Homework already exists. Regenerate it?')) return;

    try {
      if (btnElem) { btnElem.disabled = true; btnElem.textContent = 'Generating…'; }
      const md = await generateHomework(s.transcript || '');

      // Update homework in Supabase
      await supabase
        .from('sessions')
        .update({ homework_md: md || '' })
        .eq('id', sessionId)

      await renderHistory();
      const pre = document.getElementById('h-' + sessionId);
      if (pre) { pre.textContent = md || ''; pre.style.display = 'block'; }
      alert('Homework ready.');
    } catch (e) {
      console.error(e);
      alert('Failed to generate homework: ' + e.message);
    } finally {
      if (btnElem) { btnElem.disabled = false; btnElem.textContent = 'Homework'; }
    }
  }

  // ===== HISTORY (with Summary controls) + show student =====
  async function renderHistory(){
    const sessions = await loadSessions();
    sessionCountEl.textContent = sessions.length;
    historyEl.innerHTML = '';
    sessions.forEach(s => {
      const hasSummary = !!s.summary_md;
      const hasHomework = !!s.homework_md;
      const generating = isGenerating(s.id);
      const empty = isEmpty(s.id);
      const stu = s.student?.name || '—';
      const studentLine = s.student_id
        ? `<a href="student.html?id=${s.student_id}" class="small">student: ${stu}</a>`
        : `<span class="sub small">student: —</span>`;
      const div = document.createElement('div');
      div.className = 'hist-item';
      div.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <div>
            <div><strong>${s.timestamp}</strong></div>
            <div class="sub small">${fmtTime(s.duration_ms || 0)} — ${s.id}</div>
            <div class="sub small">${studentLine}</div>
          </div>
          <div class="row">
            <button data-act="view" data-id="${s.id}" class="secondary">View</button>
            <button data-act="copy" data-id="${s.id}" class="secondary">Copy</button>
            <button data-act="dl" data-id="${s.id}" class="secondary">Export .txt</button>
            <button data-act="del" data-id="${s.id}" class="danger">Delete</button>
          </div>
        </div>

        <div class="row" style="margin-top:8px; justify-content:flex-end; gap:8px">
          <span class="small sub" style="margin-right:auto">Summary:</span>
          ${empty ?
            '<span class="pill small" style="background:#f59e0b; color:#ffffff">Empty transcript - no content generated</span>' :
            generating ?
              '<span class="pill small generating-pill generating-dots">Generating</span>' :
              `<button data-act="sum" data-id="${s.id}" class="${hasSummary ? 'regenerate-btn' : 'secondary'}">${hasSummary ? 'Regenerate' : 'Summary'}</button>`
          }
          ${hasSummary ? `
            <button data-act="sumview" data-id="${s.id}" class="secondary">View Summary</button>
            <button data-act="sumcopy" data-id="${s.id}" class="secondary">Copy .md</button>
            <button data-act="sumdl" data-id="${s.id}" class="secondary">Export .md</button>
          ` : ''}
        </div>

        <div class="row" style="margin-top:8px; justify-content:flex-end; gap:8px">
          <span class="small sub" style="margin-right:auto">Homework:</span>
          ${empty ?
            '<span class="pill small" style="background:#f59e0b; color:#ffffff">Empty transcript - no content generated</span>' :
            generating ?
              '<span class="pill small generating-pill generating-dots">Generating</span>' :
              `<button data-act="hw" data-id="${s.id}" class="${hasHomework ? 'regenerate-btn' : 'secondary'}">${hasHomework ? 'Regenerate' : 'Homework'}</button>`
          }
          ${hasHomework ? `
            <button data-act="hwview" data-id="${s.id}" class="secondary">View Homework</button>
            <button data-act="hwcopy" data-id="${s.id}" class="secondary">Copy .md</button>
            <button data-act="hwdl" data-id="${s.id}" class="secondary">Export .md</button>
          ` : ''}
        </div>

        <pre id="p-${s.id}" style="display:none;margin-top:10px" class="transcript small"></pre>
        <pre id="s-${s.id}" style="display:none;margin-top:10px" class="transcript small">${hasSummary ? (s.summary_md || '') : ''}</pre>
        <pre id="h-${s.id}" style="display:none;margin-top:10px" class="transcript small">${hasHomework ? (s.homework_md || '') : ''}</pre>
      `;
      historyEl.appendChild(div);
    });

    historyEl.querySelectorAll('button').forEach(btn=>{
      btn.onclick = async () => {
        const id = btn.getAttribute('data-id');
        const act = btn.getAttribute('data-act');

        // Get session from Supabase
        const { data: s, error } = await supabase
          .from('sessions')
          .select('*')
          .eq('id', id)
          .single()

        if (error || !s) {
          console.error('Session not found:', error)
          return
        }

        if (act==='view'){
          const pre = document.getElementById('p-'+id);
          pre.textContent = s.transcript || '';
          pre.style.display = pre.style.display==='none' ? 'block' : 'none';
        } else if (act==='copy'){
          navigator.clipboard.writeText(s.transcript || '');
          alert('Copied.');
        } else if (act==='dl'){
          const blob = new Blob([`[${s.timestamp}] (${fmtTime(s.duration_ms||0)})\n\n${s.transcript||''}`], {type:'text/plain'});
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `${(s.id||'session')}.txt`;
          a.click();
          URL.revokeObjectURL(a.href);
        } else if (act==='del'){
          if (!confirm('Delete this session?')) return;
          await supabase.from('sessions').delete().eq('id', id);
          await renderHistory();
        } else if (act==='sum'){
          await summarizeSessionById(id, btn);
        } else if (act==='sumview'){
          if (!s.summary_md) return;
          const pre = document.getElementById('s-'+id);
          pre.style.display = pre.style.display==='none' ? 'block' : 'none';
        } else if (act==='sumcopy'){
          if (!s.summary_md) return;
          await navigator.clipboard.writeText(s.summary_md);
          alert('Summary copied.');
        } else if (act==='sumdl'){
          if (!s.summary_md) return;
          const blob = new Blob([s.summary_md], {type:'text/markdown'});
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `${(s.id||'session')}-summary.md`;
          a.click();
          URL.revokeObjectURL(a.href);
        } else if (act==='hw'){
          await homeworkSessionById(id, btn);
        } else if (act==='hwview'){
          if (!s.homework_md) return;
          const pre = document.getElementById('h-'+id);
          pre.style.display = pre.style.display==='none' ? 'block' : 'none';
        } else if (act==='hwcopy'){
          if (!s.homework_md) return;
          await navigator.clipboard.writeText(s.homework_md);
          alert('Homework copied.');
        } else if (act==='hwdl'){
          if (!s.homework_md) return;
          const blob = new Blob([s.homework_md], {type:'text/markdown'});
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `${(s.id||'session')}-homework.md`;
          a.click();
          URL.revokeObjectURL(a.href);
        }
      };
    });
  }
  await renderHistory();

  // Expose renderHistory globally so autoGenerateContent can refresh the UI
  window.renderHistoryRefresh = renderHistory;


  // ===== AUTH LOGIC =====
  async function checkAuth() {
    const { data: { session } } = await supabase.auth.getSession()
    if (session) {
      await showApp(session.user)
    } else {
      showAuth()
    }
  }

  function showAuth() {
    authSection.style.display = 'block'
    appSection.style.display = 'none'
  }

  async function showApp(user) {
    authSection.style.display = 'none'
    appSection.style.display = 'block'
    userEmail.textContent = user.email

    // Check if BYOK keys are set - if not, show modal in blocking mode
    if (!areBYOKKeysSet()) {
      showBYOKModal(true) // blocking mode
      return // Don't initialize app until keys are set
    }

    await setCurrentStudent(currentStudentId) // Initialize the current student pill
    await renderHistory()
  }

  // ===== TAB SWITCHING LOGIC =====
  function switchToTab(mode) {
    currentAuthMode = mode
    hideMessage()

    if (mode === 'signin') {
      // Update tab appearance
      signInTab.style.background = 'var(--accent)'
      signInTab.style.color = '#0a0a0a'
      signUpTab.style.background = 'transparent'
      signUpTab.style.color = 'var(--muted)'

      // Show/hide forms
      signInForm.style.display = 'block'
      signUpForm.style.display = 'none'
    } else {
      // Update tab appearance
      signUpTab.style.background = 'var(--accent)'
      signUpTab.style.color = '#0a0a0a'
      signInTab.style.background = 'transparent'
      signInTab.style.color = 'var(--muted)'

      // Show/hide forms
      signUpForm.style.display = 'block'
      signInForm.style.display = 'none'
    }
  }

  // Tab click handlers
  signInTab.onclick = () => switchToTab('signin')
  signUpTab.onclick = () => switchToTab('signup')

  // ===== MESSAGE DISPLAY =====
  function showMessage(text, type = 'error') {
    authMessage.textContent = text
    authMessage.style.display = 'block'
    if (type === 'success') {
      authMessage.style.background = 'rgba(34, 197, 94, 0.1)'
      authMessage.style.color = 'var(--ok)'
      authMessage.style.border = '1px solid rgba(34, 197, 94, 0.2)'
    } else {
      authMessage.style.background = 'rgba(239, 68, 68, 0.1)'
      authMessage.style.color = '#ef4444'
      authMessage.style.border = '1px solid rgba(239, 68, 68, 0.2)'
    }
  }

  function hideMessage() {
    authMessage.style.display = 'none'
  }

  // ===== SIGN IN HANDLER =====
  signInBtn.onclick = async () => {
    const email = signInEmail.value.trim()
    const password = signInPassword.value.trim()

    if (!email) {
      showMessage('Please enter your email')
      return
    }
    if (!password) {
      showMessage('Please enter your password')
      return
    }

    try {
      signInBtn.disabled = true
      signInBtn.textContent = 'Signing in...'
      hideMessage()

      const { error } = await supabase.auth.signInWithPassword({
        email: email,
        password: password
      })

      if (error) throw error
      // showApp() will be called by onAuthStateChange
    } catch (error) {
      showMessage('Error: ' + error.message)
    } finally {
      signInBtn.disabled = false
      signInBtn.textContent = 'Sign In'
    }
  }

  // ===== SIGN UP HANDLER =====
  signUpBtn.onclick = async () => {
    const email = signUpEmail.value.trim()
    const password = signUpPassword.value.trim()

    if (!email) {
      showMessage('Please enter your email')
      return
    }
    if (!password) {
      showMessage('Please enter your password')
      return
    }
    if (password.length < 6) {
      showMessage('Password must be at least 6 characters')
      return
    }

    try {
      signUpBtn.disabled = true
      signUpBtn.textContent = 'Creating account...'
      hideMessage()

      const { error } = await supabase.auth.signUp({
        email: email,
        password: password,
        options: {
          emailRedirectTo: window.location.origin + '/index.html'
        }
      })

      if (error) throw error

      showMessage('Account created successfully! You can now sign in.', 'success')

      // Clear form and switch to sign-in
      signUpEmail.value = ''
      signUpPassword.value = ''
      setTimeout(() => {
        switchToTab('signin')
      }, 2000)

    } catch (error) {
      showMessage('Error: ' + error.message)
    } finally {
      signUpBtn.disabled = false
      signUpBtn.textContent = 'Create Account'
    }
  }

  logoutBtn.onclick = async () => {
    await supabase.auth.signOut()
    showAuth()
  }

  // Listen for auth changes
  supabase.auth.onAuthStateChange((event, session) => {
    if (event === 'SIGNED_IN' && session) {
      showApp(session.user)
    } else if (event === 'SIGNED_OUT') {
      showAuth()
    }
  })

  // ===== INITIALIZE AUTH UI =====
  function initializeAuthUI() {
    // Set default tab to sign-in
    switchToTab('signin')

    // Add Enter key support for forms
    signInEmail.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') signInPassword.focus()
    })

    signInPassword.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') signInBtn.click()
    })

    signUpEmail.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') signUpPassword.focus()
    })

    signUpPassword.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') signUpBtn.click()
    })
  }

  // Initialize everything
  initializeAuthUI()
  checkAuth()
</script>
</body>
</html>
